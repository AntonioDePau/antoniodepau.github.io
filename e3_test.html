<html>
	<head>
	<title>E3 2017</title>
	<link rel="icon" type="image/png" href="favicon.png" sizes="192x192">
	<style>
	body{
	background-image: url(http://www.actugaming.net/wp-content/uploads/2017/05/E3-2017.png);
	background-size: 100% 100%;
	vertical-align:middle;
    text-align: center;
	}
	table {
	border-collapse: collapse;
	border-radius: 10px;
	margin-top: 50px;
	//margin-left:160px;
	}
	th, td {
	background-color: rgba(255, 255, 255, .85);
	//color: rgba(255, 255, 255, .5);
	color: black;
	padding: 5px;
    border: 1px solid black;
    border-collapse: collapse;
	}
	
	img {
	max-height: 50px;
	max-width: 50px;
	}
	
	tr > td:last-child {
	text-align:center;
	}
</style>
	</head>
	
	<body style="">
	<div style="width:auto;margin:50 auto auto 35;display: inline-block;vertical-align:middle">
		<table id="table">
		<tr>
			<td style="border: none; background-color: rgba(255, 255, 255,0);color: rgba(255,255,255,0);"></td>
			<th>Jour</th>
			<th>Temps restant</th>
			<th>Visionner sur</th>
		</tr>		
		</table>
		
		<table style="border-collapse: collapse;"><tr><td style="text-align:left;">
		<label><input id="thirty_m_remind" type='checkbox' onclick='handleClick(this);' checked>Receive audio notification 30 minutes before a conference starts</label><br>
		<label><input id="five_m_remind" type='checkbox' onclick='handleClick(this);' checked>Receive audio notification 5 minutes before a conference starts</label><br>
		<label><input id="thirty_s_remind" type='checkbox' onclick='handleClick(this);' checked>Receive audio notification 30 sec before a conference starts</label><br>
		</td></tr></table>

	</div>
	</body>
</html>

<script>
var thirty_m = new Audio('30m.mp3');
var five_m = new Audio('5m.mp3');
var thirty_s = new Audio('30s.mp3');

var yt_logo = "https://www.youtube.com/yt/brand/media/image/YouTube-icon-full_color.png";
var tw_logo = "https://i.warosu.org/data/g/img/0488/82/1436268496494.png";

//var total = new Date("Jun 12, 2017 06:00:00") + (30*60)*1000;

var streams = {
"ea": {
"name":"Electronic Arts",
"date":new Date("Jun 10, 2017 21:00:00"),
"yt":"https://www.youtube.com/watch?v=P9BB0ambDQw",
"tw":"https://www.twitch.tv/ea"
},
"xb": {
"name":"Xbox",
"date":new Date("Jun 11, 2017 23:00:00"),
"tw":"https://www.twitch.tv/xbox",
"yt":"https://www.youtube.com/watch?v=dZ4GpE3c97U"
},
"beth": {
"name":"Bethesda",
"date":new Date("Jun 12, 2017 06:00:00"),
"tw":"https://www.twitch.tv/bethesda",
"yt":"https://www.youtube.com/watch?v=gbslVwy0XzY"
},
"dev": {
"name":"Devolver",
"date":new Date("Jun 12, 2017 07:00:00"),
"tw":"https://www.twitch.tv/devolverdigital"
},
"pc": {
"name":"PC gaming show",
"date":new Date("Jun 12, 2017 19:00:00"),
"tw":"https://www.twitch.tv/pcgamer"
},
"ubi": {
"name":"Ubisoft",
"date":new Date("Jun 12, 2017 22:00:00"),
"tw":"https://www.twitch.tv/ubisoft"
},
"ps": {
"name":"Playstation",
"date":new Date("Jun 13, 2017 03:00:00"),
"tw":"https://www.twitch.tv/playstation"
},
"nd": {
"name":"Nintendo Direct",
"date":new Date("Jun 13, 2017 18:00:00"),
"tw":"https://www.twitch.tv/nintendo"
},
"test": {
"name":"Test Direct",
"date":new Date(new Date().setSeconds(new Date().getSeconds()+1805)), //+30 minutes
//"date":new Date(new Date().setSeconds(new Date().getSeconds()+305)), //+5 minutes
//"date":new Date(new Date().setSeconds(new Date().getSeconds()+36)), //+30 seconds
"tw":"https://www.twitch.tv/nintendo"
}
//"test": {
//"name":"Test Direct",
//"date":new Date(new Date().setSeconds(new Date().getSeconds()+1805)), //+30 minutes
//"date":new Date(new Date().setSeconds(new Date().getSeconds()+305)), //+5 minutes
//"date":new Date(new Date().setSeconds(new Date().getSeconds()+36)), //+30 seconds
//"tw":"https://www.twitch.tv/nintendo"
//}
};

function formatDate(date) {
  var dayNames = ["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"];
  var dayIndex = date.getDay();
  var day = date.getDate();
  var hour = date.getHours();
  return dayNames[dayIndex] +" "+ day +" à "+ hour +"h";
}

var interval = function(obj){
	var x = setInterval(function() {
		count(obj, streams[obj]);
	}, 1000);
};

for (var i = 0; i < Object.keys(streams).length; i++){
    var obj = Object.keys(streams)[i];
	var table = document.getElementById("table");
	table.innerHTML = table.innerHTML + '<tr><td id="'+obj+'">'+streams[obj].name+'</td><td id="'+obj+'_date"></td><td id="'+obj+'_heure"></td><td id="'+obj+'_stream"></td></tr>';	
	var stream = document.getElementById(obj+"_stream");
	var date = document.getElementById(obj+"_date");
		if (streams[obj].date && streams[obj].date !== ""){
		date.innerHTML = formatDate(streams[obj].date);
		}
		if (streams[obj].yt && streams[obj].yt !== ""){
	    stream.innerHTML = '<a target="_blank" href="'+streams[obj].yt+'"><img style="max-height:25px;" src="'+yt_logo+'"></a>';
		}
		if (streams[obj].tw && streams[obj].tw !== ""){
		stream.innerHTML = stream.innerHTML + '<a target="_blank" href="'+streams[obj].tw+'"><img src="'+tw_logo+'"></a><br>';
		}
		interval(obj);
}

var thirty_m_remind = true;
var five_m_remind = true;
var thirty_s_remind = true;

function handleClick(cb) {
  //display("Clicked, new value = " + cb.checked);
  var chk=cb.checked;
  if (cb.id == "thirty_m_remind"){ thirty_m_remind = chk;};
  if (cb.id == "five_m_remind"){ five_m_remind = chk;};
  if (cb.id == "thirty_s_remind"){ thirty_s_remind = chk;};
}

// request permission on page load
document.addEventListener('DOMContentLoaded', function () {
  if (Notification.permission !== "granted")
    Notification.requestPermission();
});

function notifyMe(time,conf) {
  if (!Notification) {
    alert('Desktop notifications not available in your browser. Try Chromium.'); 
    return;
  }

  if (Notification.permission !== "granted")
    Notification.requestPermission();
  else {
    var notification = new Notification(conf+' conference going live in '+time, {
      icon: 'favicon.png',
      body: "Click here to watch the conference!",
    });

    notification.onclick = function () {
      window.open(obj.tw);      
    };
    
  }

}

var count = function(Conf, obj){
datet = obj.date;
var now = new Date().getTime();
  var distance = datet - now;
  var days = Math.floor(distance / (1000 * 60 * 60 * 24));
  var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  var seconds = Math.floor((distance % (1000 * 60)) / 1000);

  document.getElementById(Conf+"_heure").innerHTML = days + "j " + hours + "h "
  + minutes + "m " + seconds + "s";
  if (distance < (60*30)*1000 && distance > 0) {
    document.getElementById(Conf+"_heure").style.color = "red";
    document.getElementById(Conf+"_heure").style.fontWeight = "bold";
  }
  if (distance < 1800000 && distance > 1799000 && thirty_m_remind) { //INF 30 minutes
  notifyMe("30m",Conf,obj);
  thirty_m.play();
  }
  if (distance < 300000 && distance > 299000 && five_m_remind) { // INF 5 minutes
  five_m.play();
  }
  if (distance < 33000 && distance > 32000 && thirty_s_remind) { // INF 30 seconds
  thirty_s.play();
  }
  
  if (distance < 0) {
    document.getElementById(Conf+"_heure").innerHTML = "Conférence débutée";
  }
}
</script>